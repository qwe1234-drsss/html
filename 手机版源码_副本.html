<!doctype html>
<html lang="zh-CN" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>èµ„äº§å·¥ä½œå°ï¼ˆæ‰‹æœºç«¯ï¼‰</title>
  <style>
    :root{
      --bg0:#0b1220; --bg1:#0f1a2e; --card:#0f1a2e; --card2:#12203a;
      --stroke:rgba(255,255,255,.10);
      --text:rgba(255,255,255,.92); --muted:rgba(255,255,255,.66); --muted2:rgba(255,255,255,.45);
      --brand:#2dd4bf; --brand2:#60a5fa;
      --ok:#34d399; --warn:#fbbf24; --danger:#fb7185;
      --shadow:0 18px 46px rgba(0,0,0,.35);
      --r:18px;
      --font: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI","PingFang SC","Hiragino Sans GB","Microsoft YaHei", Arial, sans-serif;
    }
    [data-theme="light"]{
      --bg0:#f8faff; --bg1:#eef4ff; --card:#ffffff; --card2:#f6f8ff;
      --stroke:#dbe5ff;
      --text:#0f172a; --muted:#46536b; --muted2:#6b7c96;
      --shadow:0 16px 40px rgba(10,20,50,.10);
    }
    *{box-sizing:border-box}
    html,body{height:100%; margin:0; font-family:var(--font); color:var(--text)}
    body{
      background:
        radial-gradient(900px 600px at 20% 0%, rgba(45,212,191,.18), transparent 55%),
        radial-gradient(900px 600px at 80% 0%, rgba(96,165,250,.18), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow:hidden;
    }
    .app{height:100%; display:flex; flex-direction:column}
    .topbar{
      padding:12px 14px 10px;
      border-bottom:1px solid var(--stroke);
      background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,0));
    }
    .titleRow{display:flex; align-items:center; justify-content:space-between; gap:10px}
    .h1{font-size:16px; font-weight:900; margin:0}
    .sub{font-size:12px; color:var(--muted); margin-top:4px}
    .iconBtn{
      border:1px solid var(--stroke); background:var(--card);
      padding:8px 10px; border-radius:12px; color:var(--text);
      cursor:pointer; display:flex; align-items:center; gap:6px;
      box-shadow: 0 8px 22px rgba(0,0,0,.18);
    }
    .iconBtn:active{transform:translateY(1px)}
    .content{
      flex:1; overflow:auto;
      padding:12px 12px 90px; /* bottom nav + safe area */
      -webkit-overflow-scrolling:touch;
    }
    .grid{display:grid; gap:12px}
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
      border:1px solid var(--stroke);
      border-radius:var(--r);
      box-shadow:var(--shadow);
      padding:12px;
    }
    .cardHead{display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px}
    .cardTitle{font-weight:900; font-size:14px}
    .muted{color:var(--muted)}
    .muted2{color:var(--muted2)}
    .small{font-size:12px}
    .pill{
      font-size:11px; padding:3px 8px; border-radius:999px;
      border:1px solid var(--stroke); background:var(--card2); color:var(--muted);
      white-space:nowrap;
    }
    .row{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
    .bigNum{font-size:24px; font-weight:1000; letter-spacing:.2px}
    .btn{
      border:1px solid var(--stroke); background:var(--card);
      padding:10px 12px; border-radius:14px;
      color:var(--text); cursor:pointer;
      display:flex; align-items:center; justify-content:center; gap:6px;
      font-weight:800;
    }
    .btn.primary{
      background:linear-gradient(135deg, rgba(45,212,191,.20), rgba(96,165,250,.14));
      border-color: rgba(45,212,191,.35);
    }
    .btn.ghost{background:transparent}
    .btn:active{transform:translateY(1px)}
    .fab{
      position:fixed; right:14px; bottom:86px;
      padding:12px 14px; border-radius:999px;
      background:linear-gradient(135deg, rgba(45,212,191,.90), rgba(96,165,250,.90));
      color:#fff; font-weight:1000; border:none;
      box-shadow:0 18px 50px rgba(0,0,0,.35);
      cursor:pointer;
    }
    .fab:active{transform:translateY(1px)}
    .bottomNav{
      position:fixed; left:0; right:0; bottom:0;
      padding:10px 10px calc(10px + env(safe-area-inset-bottom));
      border-top:1px solid var(--stroke);
      background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
      backdrop-filter: blur(10px);
    }
    .tabs{display:grid; grid-template-columns:1fr 1fr 1fr; gap:8px}
    .tab{
      border:1px solid var(--stroke); background:var(--card);
      border-radius:16px; padding:10px 8px;
      display:flex; flex-direction:column; align-items:center; gap:4px;
      cursor:pointer; color:var(--muted);
      font-size:12px; font-weight:800;
    }
    .tab.active{
      color:var(--text);
      border-color: rgba(45,212,191,.35);
      background:linear-gradient(135deg, rgba(45,212,191,.16), rgba(96,165,250,.10));
    }
    .tab .emoji{font-size:16px}

    /* bars */
    .barList{display:flex; flex-direction:column; gap:10px}
    .barItem{display:flex; flex-direction:column; gap:6px}
    .barTop{display:flex; justify-content:space-between; gap:10px; font-size:12px}
    .barTrack{
      height:10px; border-radius:999px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.08);
      overflow:hidden;
    }
    [data-theme="light"] .barTrack{
      background:rgba(15,23,42,.06);
      border-color:rgba(15,23,42,.10);
    }
    .barFill{
      height:100%;
      width:0%;
      background:linear-gradient(90deg, rgba(45,212,191,.95), rgba(96,165,250,.95));
      border-radius:999px;
    }

    /* form */
    .field{display:flex; flex-direction:column; gap:6px; margin:10px 0}
    label{font-size:12px; color:var(--muted); font-weight:800}
    input, select, textarea{
      border:1px solid var(--stroke); background:var(--card2);
      color:var(--text); padding:10px 10px;
      border-radius:14px; outline:none; font-size:14px;
    }
    textarea{min-height:90px; resize:vertical}
    .chips{display:flex; flex-wrap:wrap; gap:8px}
    .chip{
      padding:8px 10px; border-radius:999px;
      border:1px solid var(--stroke); background:var(--card);
      color:var(--muted); font-size:12px; font-weight:900;
      cursor:pointer;
    }
    .chip.active{
      color:var(--text);
      border-color: rgba(45,212,191,.35);
      background:linear-gradient(135deg, rgba(45,212,191,.16), rgba(96,165,250,.10));
    }

    /* drawer/modal */
    .overlay{
      position:fixed; inset:0;
      background:rgba(0,0,0,.45);
      display:none; align-items:flex-end; justify-content:center;
      padding:14px;
    }
    .sheet{
      width:100%; max-width:680px;
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid var(--stroke);
      border-radius:22px;
      box-shadow:var(--shadow);
      padding:12px;
      max-height:82vh;
      overflow:auto;
    }
    .sheetHead{display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:6px}
    .sheetTitle{font-size:14px; font-weight:1000}
    .x{border:1px solid var(--stroke); background:var(--card); padding:8px 10px; border-radius:12px; cursor:pointer; color:var(--text)}
    .list{display:flex; flex-direction:column; gap:10px}
    .item{
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.02);
      border-radius:16px;
      padding:10px;
    }
    [data-theme="light"] .item{
      border-color:rgba(15,23,42,.12);
      background:rgba(15,23,42,.03);
    }
    .itemTitle{font-weight:1000; font-size:13px}
    .itemMeta{margin-top:6px; display:flex; gap:8px; flex-wrap:wrap}
    .tag{font-size:11px; padding:3px 8px; border-radius:999px; border:1px solid var(--stroke); background:var(--card2); color:var(--muted)}
    .warnBox{
      border:1px solid rgba(251,191,36,.35);
      background: rgba(251,191,36,.10);
      border-radius:16px;
      padding:10px;
      color: var(--text);
    }
  </style>
</head>

<body>
<div class="app">
  <div class="topbar">
    <div class="titleRow">
      <div>
        <div class="h1" id="topTitle">æ¦‚è§ˆ</div>
        <div class="sub" id="topSub">ç±»åˆ«å æ¯”ä¼˜å…ˆ Â· ç¦»çº¿å¯ç”¨ Â· æ”¯æŒè‡ªå®šä¹‰</div>
      </div>
      <button class="iconBtn" id="btnTheme" title="ä¸»é¢˜">
        ğŸ¨ <span class="small muted" id="themeLabel">æ·±è‰²</span>
      </button>
    </div>
  </div>

  <div class="content" id="content">
    <!-- Overview -->
    <div id="page-overview" class="grid">
      <div class="card">
        <div class="cardHead">
          <div class="cardTitle">æ€»èµ„äº§</div>
          <div class="row">
            <span class="pill" id="lastUpdated">æœªæ›´æ–°</span>
            <button class="iconBtn" id="btnMask" title="é®ç½©é‡‘é¢">ğŸ‘ <span class="small muted" id="maskLabel">æ˜¾ç¤º</span></button>
          </div>
        </div>

        <div id="totalsArea">
          <div class="bigNum" id="totalBase">â€”</div>
          <div class="small muted" id="totalHint">è®¾ç½®é‡Œå¯é€‰æ‹©åŸºå‡†å¸ç§ä¸æ±‡ç‡æŠ˜ç®—</div>
        </div>

        <div id="fxWarn" class="warnBox small" style="display:none; margin-top:10px">
          ä½ æœ‰å¤šå¸ç§è®°å½•ï¼Œä½†æœªè®¾ç½®æ±‡ç‡ï¼šå æ¯”ä¸è¢«åŠ¨æ”¶å…¥å°†ä»…æŒ‰â€œåŸºå‡†å¸ç§â€æˆ–åˆ†å¸ç§å±•ç¤ºã€‚å¯å»ã€è®¾ç½® â†’ æ±‡ç‡ã€‘è¡¥å……ã€‚
        </div>
      </div>

      <div class="card">
        <div class="cardHead">
          <div class="cardTitle">ç±»åˆ«å æ¯”</div>
          <span class="pill" id="catCount">0 ç±»</span>
        </div>
        <div class="barList" id="categoryBars"></div>
        <div class="small muted2" style="margin-top:10px">ç‚¹æŸä¸€ç±»å¯æŸ¥çœ‹å…¶åœ¨å„è´¦æˆ·åˆ†å¸ƒï¼ˆåç»­å¯æ‰©å±•ï¼‰ã€‚</div>
      </div>

      <div class="card">
        <div class="cardHead">
          <div class="cardTitle">è¢«åŠ¨æ”¶å…¥ Â· ä¸‰æ¡£ç›®æ ‡</div>
          <span class="pill" id="rLabel">r=â€”</span>
        </div>

        <div class="small muted" style="line-height:1.5">
          è¢«åŠ¨æ”¶å…¥ï¼ˆæœˆï¼‰â‰ˆ å¯æŠ•èµ„èµ„äº§ Ã— å¹´åŒ–æ”¶ç›Šç‡ Ã· 12ï¼ˆä½ å¯åœ¨è®¾ç½®è‡ªå®šä¹‰ï¼‰
        </div>

        <div class="split" style="height:1px;margin:12px 0;background:linear-gradient(90deg,transparent,rgba(255,255,255,.12),transparent)"></div>

        <div class="barList" id="fireBars"></div>

        <div class="row" style="margin-top:12px">
          <button class="btn ghost" id="btnToggleETA">é¢„è®¡å¹´é™ï¼š<span id="etaState">å…³é—­</span></button>
          <button class="btn" id="btnSaveSnapshot">ä¿å­˜å¿«ç…§</button>
        </div>

        <div class="small muted2" id="etaNote" style="margin-top:10px; display:none">
          å¹´é™ä¼°ç®—ç”¨â€œå½“å‰èµ„äº§ + æ¯æœˆå‡€å‚¨è“„ + å¤åˆ©â€è®¡ç®—ï¼Œä»…ä½œå‚è€ƒï¼ˆé»˜è®¤å…³é—­ä»¥é¿å…ç„¦è™‘ï¼‰ã€‚
        </div>
      </div>

      <div class="card" id="snapshotCard" style="display:none">
        <div class="cardHead">
          <div class="cardTitle">å¿«ç…§è¶‹åŠ¿ï¼ˆæœ€è¿‘ 6 æ¬¡ï¼‰</div>
          <span class="pill" id="snapCount">0</span>
        </div>
        <div class="barList" id="snapBars"></div>
      </div>
    </div>

    <!-- Records -->
    <div id="page-records" class="grid" style="display:none">
      <div class="card">
        <div class="cardHead">
          <div class="cardTitle">å¿«é€Ÿè®°å½•</div>
          <span class="pill">æ¨¡å¼ï¼šæ€»é¢/å˜åŒ–</span>
        </div>

        <div class="field">
          <label>è´¦æˆ·</label>
          <select id="recAccount"></select>
          <div class="small muted2">å»ºè®®ä½ æ¯æ¬¡åªè®°â€œå˜åŒ–/æœ€æ–°ä½™é¢â€ï¼Œç³»ç»Ÿè‡ªåŠ¨æ±‡æ€»ã€‚</div>
        </div>

        <div class="field">
          <label>ç±»åˆ«</label>
          <div class="chips" id="catChips"></div>
        </div>

        <div class="row">
          <div class="field" style="flex:1; min-width:140px">
            <label>å¸ç§</label>
            <select id="recCcy">
              <option value="CNY">CNYï¼ˆäººæ°‘å¸ï¼‰</option>
              <option value="HKD">HKDï¼ˆæ¸¯å¸ï¼‰</option>
              <option value="USD">USDï¼ˆç¾å…ƒï¼‰</option>
            </select>
          </div>
          <div class="field" style="flex:1; min-width:140px">
            <label>é‡‘é¢</label>
            <input id="recAmount" inputmode="decimal" placeholder="ä¾‹å¦‚ 120000" />
          </div>
        </div>

        <div class="field">
          <label>å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰</label>
          <input id="recNote" placeholder="ä¾‹å¦‚ï¼šå¾®ä¿¡ç†è´¢æ›´æ–°ã€åˆ¸å•†è½¬å…¥..." />
        </div>

        <div class="row">
          <button class="btn primary" id="btnSaveRecord">ä¿å­˜å¹¶æ¸…ç©º</button>
          <button class="btn" id="btnOpenRecords">æŸ¥çœ‹æœ€è¿‘è®°å½•</button>
        </div>
      </div>

      <div class="card">
        <div class="cardHead">
          <div class="cardTitle">æœ€è¿‘è®°å½•ï¼ˆ10æ¡ï¼‰</div>
          <span class="pill" id="recCount">0</span>
        </div>
        <div class="list" id="recentRecords"></div>
      </div>
    </div>

    <!-- Settings -->
    <div id="page-settings" class="grid" style="display:none">
      <div class="card">
        <div class="cardHead">
          <div class="cardTitle">è‡ªç”±å‚æ•°</div>
          <span class="pill">å¯éšæ—¶æ”¹</span>
        </div>

        <div class="field">
          <label>åŸºå‡†å¸ç§ï¼ˆç”¨äºæŠ˜ç®—ä¸è¢«åŠ¨æ”¶å…¥ï¼‰</label>
          <select id="setBaseCcy">
            <option value="CNY">CNYï¼ˆäººæ°‘å¸ï¼‰</option>
            <option value="HKD">HKDï¼ˆæ¸¯å¸ï¼‰</option>
            <option value="USD">USDï¼ˆç¾å…ƒï¼‰</option>
          </select>
        </div>

        <div class="row">
          <div class="field" style="flex:1; min-width:140px">
            <label>å¹´åŒ–æ”¶ç›Šç‡ rï¼ˆä¾‹å¦‚ 0.06ï¼‰</label>
            <input id="setR" inputmode="decimal" placeholder="0.06" />
          </div>
          <div class="field" style="flex:1; min-width:140px">
            <label>æ¯æœˆå‡€å‚¨è“„ï¼ˆç”¨äºå¹´é™ä¼°ç®—ï¼Œå¯ç©ºï¼‰</label>
            <input id="setS" inputmode="decimal" placeholder="ä¾‹å¦‚ 20000" />
          </div>
        </div>

        <div class="field">
          <label>ä¸‰æ¡£ç›®æ ‡ï¼ˆæœˆè¢«åŠ¨æ”¶å…¥ï¼‰</label>
          <div class="row">
            <div style="flex:1; min-width:120px">
              <div class="small muted">èµ·èˆªè‡ªç”±</div>
              <input id="t1" inputmode="decimal" placeholder="20000" />
            </div>
            <div style="flex:1; min-width:120px">
              <div class="small muted">è¿›é˜¶è‡ªç”±</div>
              <input id="t2" inputmode="decimal" placeholder="50000" />
            </div>
            <div style="flex:1; min-width:120px">
              <div class="small muted">å·…å³°è‡ªç”±</div>
              <input id="t3" inputmode="decimal" placeholder="70000" />
            </div>
          </div>
        </div>

        <div class="split" style="height:1px;margin:12px 0;background:linear-gradient(90deg,transparent,rgba(255,255,255,.12),transparent)"></div>

        <div class="cardHead" style="margin-bottom:6px">
          <div class="cardTitle">æ±‡ç‡ï¼ˆå¯é€‰ï¼Œç”¨äºæŠ˜ç®—ï¼‰</div>
          <span class="pill">1 å•ä½å¤–å¸ = ? åŸºå‡†å¸ç§</span>
        </div>
        <div class="row">
          <div class="field" style="flex:1; min-width:140px">
            <label>HKD â†’ åŸºå‡†</label>
            <input id="fxHKD" inputmode="decimal" placeholder="ä¾‹å¦‚ 0.92ï¼ˆæŠ˜ç®—åˆ°CNYï¼‰" />
          </div>
          <div class="field" style="flex:1; min-width:140px">
            <label>USD â†’ åŸºå‡†</label>
            <input id="fxUSD" inputmode="decimal" placeholder="ä¾‹å¦‚ 7.20ï¼ˆæŠ˜ç®—åˆ°CNYï¼‰" />
          </div>
        </div>

        <div class="row">
          <button class="btn primary" id="btnSaveSettings">ä¿å­˜è®¾ç½®</button>
          <button class="btn" id="btnReset">æ¢å¤é»˜è®¤</button>
        </div>
      </div>

      <div class="card">
        <div class="cardHead">
          <div class="cardTitle">è´¦æˆ·ä¸ç±»åˆ«ï¼ˆè‡ªå®šä¹‰ï¼‰</div>
          <span class="pill">è¶Šç®€è¶Šå¥½</span>
        </div>

        <div class="row">
          <button class="btn" id="btnManageAccounts">ç®¡ç†è´¦æˆ·</button>
          <button class="btn" id="btnManageCategories">ç®¡ç†ç±»åˆ«</button>
        </div>

        <div class="small muted2" style="margin-top:10px">
          å»ºè®®ï¼šç±»åˆ«ä¸è¦å¤ªå¤šï¼ˆ6-10ä¸ªæœ€èˆ’æœï¼‰ï¼Œè´¦æˆ·å¯å¤šä½†å¸¸ç”¨å¯ç½®é¡¶ï¼ˆåç»­å¯åŠ ï¼‰ã€‚
        </div>
      </div>

      <div class="card">
        <div class="cardHead">
          <div class="cardTitle">æ•°æ®ï¼ˆç¦»çº¿å¤‡ä»½ï¼‰</div>
          <span class="pill">JSON</span>
        </div>
        <div class="row">
          <button class="btn" id="btnExport">å¯¼å‡ºJSON</button>
          <button class="btn" id="btnImport">å¯¼å…¥JSON</button>
          <input type="file" id="fileImport" accept="application/json" style="display:none" />
        </div>
        <div class="small muted2" style="margin-top:10px">
          å»ºè®®æ¯æœˆå¯¼å‡ºä¸€æ¬¡ï¼Œå­˜åˆ° iCloud/ç½‘ç›˜ï¼Œæ¢è®¾å¤‡ä¹Ÿä¸æ€•ã€‚
        </div>
      </div>
    </div>
  </div>

  <button class="fab" id="fab">ï¼‹ è®°ä¸€ç¬”</button>

  <div class="bottomNav">
    <div class="tabs">
      <div class="tab active" data-tab="overview"><div class="emoji">ğŸ </div><div>æ¦‚è§ˆ</div></div>
      <div class="tab" data-tab="records"><div class="emoji">âœï¸</div><div>è®°å½•</div></div>
      <div class="tab" data-tab="settings"><div class="emoji">âš™ï¸</div><div>è®¾ç½®</div></div>
    </div>
  </div>
</div>

<!-- Sheet: Manage Accounts -->
<div class="overlay" id="ovAccounts">
  <div class="sheet">
    <div class="sheetHead">
      <div class="sheetTitle">ç®¡ç†è´¦æˆ·</div>
      <button class="x" data-close="ovAccounts">å…³é—­</button>
    </div>
    <div class="field">
      <label>æ–°å¢è´¦æˆ·ï¼ˆä¾‹å¦‚ï¼šå¾®ä¿¡ç†è´¢ï¼‰</label>
      <div class="row">
        <input id="newAccountName" placeholder="è´¦æˆ·åç§°" style="flex:1" />
        <button class="btn primary" id="btnAddAccount">æ·»åŠ </button>
      </div>
    </div>
    <div class="list" id="accountList"></div>
  </div>
</div>

<!-- Sheet: Manage Categories -->
<div class="overlay" id="ovCategories">
  <div class="sheet">
    <div class="sheetHead">
      <div class="sheetTitle">ç®¡ç†ç±»åˆ«ï¼ˆç”¨äºé¦–é¡µå æ¯”ï¼‰</div>
      <button class="x" data-close="ovCategories">å…³é—­</button>
    </div>
    <div class="field">
      <label>æ–°å¢ç±»åˆ«ï¼ˆä¾‹å¦‚ï¼šå›ºæ”¶ï¼‰</label>
      <div class="row">
        <input id="newCatName" placeholder="ç±»åˆ«åç§°" style="flex:1" />
        <button class="btn primary" id="btnAddCat">æ·»åŠ </button>
      </div>
    </div>
    <div class="list" id="catList"></div>
  </div>
</div>

<!-- Sheet: Recent Records -->
<div class="overlay" id="ovRecent">
  <div class="sheet">
    <div class="sheetHead">
      <div class="sheetTitle">æœ€è¿‘è®°å½•ï¼ˆå¯åˆ é™¤ï¼‰</div>
      <button class="x" data-close="ovRecent">å…³é—­</button>
    </div>
    <div class="list" id="allRecentList"></div>
  </div>
</div>

<script>
/** ===========================
 *  Data Model (localStorage)
 * =========================== */
const LS_KEY = "portfolio_mobile_v1";

function uid(prefix="id"){ return prefix + "_" + Math.random().toString(36).slice(2,10) + "_" + Date.now().toString(36); }

const DEFAULT = () => ({
  version: 1,
  updatedAt: new Date().toISOString(),
  prefs: {
    theme: "dark",
    mask: false,
    etaEnabled: false,
  },
  settings: {
    baseCcy: "CNY",
    annualReturn: 0.06,   // r
    monthlySaving: 0,     // S
    targets: { t1: 20000, t2: 50000, t3: 70000 },
    fx: { HKD: null, USD: null } // to baseCcy
  },
  accounts: [
    { id: "acc_wechat", name: "å¾®ä¿¡ç†è´¢" },
    { id: "acc_alipay", name: "æ”¯ä»˜å®" },
    { id: "acc_xueqiu", name: "é›ªçƒ" },
    { id: "acc_east", name: "ä¸œæ–¹è´¢å¯Œ" },
    { id: "acc_broker", name: "åˆ¸å•†è´¦æˆ·" }
  ],
  categories: [
    { id: "cat_cash", name: "ç°é‡‘", order: 1 },
    { id: "cat_mm", name: "è´§å¸åŸºé‡‘", order: 2 },
    { id: "cat_fi", name: "å›ºæ”¶", order: 3 },
    { id: "cat_eq", name: "æƒç›Š", order: 4 },
    { id: "cat_fut", name: "æœŸè´§ä¿è¯é‡‘", order: 5 },
    { id: "cat_other", name: "å…¶ä»–", order: 6 }
  ],
  records: [],
  snapshots: []
});

let db = loadDB();

function loadDB(){
  try{
    const raw = localStorage.getItem(LS_KEY);
    if(!raw) return DEFAULT();
    const parsed = JSON.parse(raw);
    return { ...DEFAULT(), ...parsed }; // soft merge
  }catch(e){
    console.warn(e);
    return DEFAULT();
  }
}

function saveDB(){
  db.updatedAt = new Date().toISOString();
  localStorage.setItem(LS_KEY, JSON.stringify(db));
}

/** ===========================
 *  UI Helpers
 * =========================== */
const $ = (id) => document.getElementById(id);

function fmtMoney(x, ccy){
  if(x == null || isNaN(x)) return "â€”";
  const n = Number(x);
  const sign = n < 0 ? "-" : "";
  const abs = Math.abs(n);
  const s = abs >= 1e8 ? (abs/1e8).toFixed(2) + "äº¿" :
            abs >= 1e4 ? (abs/1e4).toFixed(2) + "ä¸‡" : abs.toFixed(2);
  return `${sign}${s} ${ccy}`;
}

function fmtPct(p){ return (p*100).toFixed(1) + "%"; }

function currentTheme(){ return document.documentElement.getAttribute("data-theme") || "dark"; }
function setTheme(th){
  document.documentElement.setAttribute("data-theme", th);
  db.prefs.theme = th;
  $("themeLabel").textContent = th === "dark" ? "æ·±è‰²" : "æµ…è‰²";
  saveDB();
}

function setMask(on){
  db.prefs.mask = on;
  $("maskLabel").textContent = on ? "é®ç½©" : "æ˜¾ç¤º";
  saveDB();
  renderAll();
}

function masked(str){
  if(!db.prefs.mask) return str;
  return "****";
}

function toBase(amount, ccy){
  const base = db.settings.baseCcy;
  if(ccy === base) return amount;
  const rate = db.settings.fx[ccy];
  if(!rate || isNaN(rate)) return null;
  return amount * Number(rate);
}

/** ===========================
 *  Navigation
 * =========================== */
function switchTab(tab){
  const map = {
    overview: ["page-overview", "æ¦‚è§ˆ", "ç±»åˆ«å æ¯”ä¼˜å…ˆ Â· ç¦»çº¿å¯ç”¨ Â· æ”¯æŒè‡ªå®šä¹‰"],
    records:  ["page-records",  "è®°å½•", "å¿«é€Ÿå½•å…¥ Â· ä¿å­˜åæ¸…ç©º Â· è‡ªåŠ¨æ±‡æ€»"],
    settings: ["page-settings", "è®¾ç½®", "æ”¶ç›Šç‡/ç›®æ ‡/æ±‡ç‡ Â· è´¦æˆ·ä¸ç±»åˆ« Â· å¯¼å…¥å¯¼å‡º"]
  };
  Object.values(map).forEach(([pid]) => $(pid).style.display = "none");
  $(map[tab][0]).style.display = "grid";
  $("topTitle").textContent = map[tab][1];
  $("topSub").textContent = map[tab][2];

  document.querySelectorAll(".tab").forEach(t=>{
    t.classList.toggle("active", t.dataset.tab === tab);
  });

  // FAB behavior
  $("fab").style.display = (tab === "records") ? "none" : "block";
}

document.querySelectorAll(".tab").forEach(t=>{
  t.addEventListener("click", ()=>switchTab(t.dataset.tab));
});
$("fab").addEventListener("click", ()=>{ switchTab("records"); });

/** ===========================
 *  Sheets
 * =========================== */
function openOverlay(id){ $(id).style.display = "flex"; }
function closeOverlay(id){ $(id).style.display = "none"; }

document.querySelectorAll("[data-close]").forEach(btn=>{
  btn.addEventListener("click", ()=>closeOverlay(btn.dataset.close));
});
document.querySelectorAll(".overlay").forEach(ov=>{
  ov.addEventListener("click", (e)=>{
    if(e.target === ov) ov.style.display="none";
  });
});

/** ===========================
 *  Records
 * =========================== */
function populateAccountSelect(){
  const sel = $("recAccount");
  sel.innerHTML = "";
  db.accounts.forEach(a=>{
    const opt = document.createElement("option");
    opt.value = a.id;
    opt.textContent = a.name;
    sel.appendChild(opt);
  });
}

let activeCatId = null;

function renderCatChips(){
  const wrap = $("catChips");
  wrap.innerHTML = "";
  const cats = [...db.categories].sort((a,b)=>a.order-b.order);
  cats.forEach(c=>{
    const chip = document.createElement("div");
    chip.className = "chip" + (activeCatId===c.id ? " active":"");
    chip.textContent = c.name;
    chip.addEventListener("click", ()=>{
      activeCatId = c.id;
      renderCatChips();
    });
    wrap.appendChild(chip);
  });
  if(!activeCatId && cats.length) activeCatId = cats[0].id;
}

function addRecord(){
  const accountId = $("recAccount").value;
  const ccy = $("recCcy").value;
  const amount = Number(($("recAmount").value||"").replace(/,/g,""));
  const note = ($("recNote").value||"").trim();

  if(!accountId){ alert("è¯·é€‰æ‹©è´¦æˆ·"); return; }
  if(!activeCatId){ alert("è¯·é€‰æ‹©ç±»åˆ«"); return; }
  if(!Number.isFinite(amount) || amount<=0){ alert("è¯·è¾“å…¥æ­£ç¡®é‡‘é¢ï¼ˆ>0ï¼‰"); return; }

  db.records.unshift({
    id: uid("rec"),
    ts: new Date().toISOString(),
    accountId, categoryId: activeCatId,
    ccy, amount,
    note
  });

  // clear for fast next entry
  $("recAmount").value = "";
  $("recNote").value = "";
  $("recAmount").focus();

  saveDB();
  renderAll();
}

$("btnSaveRecord").addEventListener("click", addRecord);
$("btnOpenRecords").addEventListener("click", ()=>{
  renderAllRecentSheet();
  openOverlay("ovRecent");
});

/** ===========================
 *  Compute
 * =========================== */
function summarize(){
  const base = db.settings.baseCcy;
  const totalsByCcy = {};
  const totalsByCatBase = {}; // in base if convertible
  const totalsByCatRaw = {};  // per ccy raw (for fallback)
  const hasMultiCcy = new Set();

  db.records.forEach(r=>{
    totalsByCcy[r.ccy] = (totalsByCcy[r.ccy]||0) + r.amount;
    hasMultiCcy.add(r.ccy);

    const cat = r.categoryId;
    totalsByCatRaw[cat] = totalsByCatRaw[cat] || {};
    totalsByCatRaw[cat][r.ccy] = (totalsByCatRaw[cat][r.ccy]||0) + r.amount;

    const conv = toBase(r.amount, r.ccy);
    if(conv != null){
      totalsByCatBase[cat] = (totalsByCatBase[cat]||0) + conv;
    }
  });

  // base total
  let totalBase = 0;
  let canConvertAll = true;
  Object.keys(totalsByCcy).forEach(ccy=>{
    if(ccy === base){ totalBase += totalsByCcy[ccy]; }
    else{
      const rate = db.settings.fx[ccy];
      if(!rate || isNaN(rate)) canConvertAll = false;
      else totalBase += totalsByCcy[ccy]*Number(rate);
    }
  });

  return {
    base,
    totalsByCcy,
    totalsByCatBase,
    totalsByCatRaw,
    totalBase: canConvertAll ? totalBase : null,
    hasMultiCcy: hasMultiCcy.size > 1,
    canConvertAll
  };
}

/** ===========================
 *  Overview Rendering
 * =========================== */
function renderTotals(sum){
  $("lastUpdated").textContent = "æ›´æ–°ï¼š" + new Date(db.updatedAt).toLocaleString();

  const area = $("totalsArea");
  const base = sum.base;

  // show base-converted total if possible
  if(sum.totalBase != null){
    const txt = fmtMoney(sum.totalBase, base);
    $("totalBase").textContent = masked(txt);
    $("totalHint").textContent = "æŠ˜ç®—åˆ°åŸºå‡†å¸ç§ï¼š" + base;
    $("fxWarn").style.display = "none";
  }else{
    // fallback: show per currency
    const parts = Object.entries(sum.totalsByCcy)
      .sort((a,b)=>b[1]-a[1])
      .map(([ccy,v]) => masked(fmtMoney(v, ccy)));

    $("totalBase").textContent = parts.length ? parts[0] : "â€”";
    $("totalHint").textContent = parts.length>1 ? ("å…¶ä»–å¸ç§ï¼š" + parts.slice(1).join(" Â· ")) : ("åŸºå‡†å¸ç§ï¼š" + base + "ï¼ˆå¯è®¾ç½®æ±‡ç‡æŠ˜ç®—ï¼‰");
    $("fxWarn").style.display = sum.hasMultiCcy ? "block" : "none";
  }
}

function renderCategoryBars(sum){
  const cats = [...db.categories].sort((a,b)=>a.order-b.order);
  $("catCount").textContent = cats.length + " ç±»";

  const wrap = $("categoryBars");
  wrap.innerHTML = "";

  // choose data source: if convertible total exists use base; else use base currency only
  const base = sum.base;
  let totalForPct = 0;
  const values = cats.map(c=>{
    let v = 0;

    if(sum.totalBase != null){
      v = sum.totalsByCatBase[c.id] || 0;
    }else{
      // base only
      const raw = sum.totalsByCatRaw[c.id] || {};
      v = raw[base] || 0;
    }
    totalForPct += v;
    return { cat:c, value:v };
  });

  if(totalForPct <= 0){
    wrap.innerHTML = `<div class="small muted">æš‚æ— æ•°æ®ã€‚å»ã€è®°å½•ã€‘é‡Œå…ˆè®°ä¸€ç¬”å§ï½</div>`;
    return;
  }

  // sort desc for nicer visual but keep a stable order? you prefer categories order, so keep order.
  values.forEach(({cat,value})=>{
    const p = value/totalForPct;

    const item = document.createElement("div");
    item.className = "barItem";
    item.innerHTML = `
      <div class="barTop">
        <div><b>${cat.name}</b> <span class="muted2">Â· ${fmtPct(p)}</span></div>
        <div class="muted">${masked(fmtMoney(value, base))}</div>
      </div>
      <div class="barTrack"><div class="barFill" style="width:${Math.max(2, p*100)}%"></div></div>
    `;
    wrap.appendChild(item);
  });
}

function renderFIRE(sum){
  const base = sum.base;
  const r = Number(db.settings.annualReturn || 0);
  $("rLabel").textContent = "r=" + (isFinite(r) ? (r*100).toFixed(1)+"%" : "â€”");

  // investable base = totalBase if available else base currency subtotal
  let investableBase = 0;
  if(sum.totalBase != null){
    investableBase = sum.totalBase;
  }else{
    investableBase = sum.totalsByCcy[base] || 0;
  }

  const monthlyPassive = investableBase * (r/12);
  const targets = db.settings.targets || {t1:20000,t2:50000,t3:70000};
  const rows = [
    {name:"èµ·èˆªè‡ªç”±", target:Number(targets.t1||0)},
    {name:"è¿›é˜¶è‡ªç”±", target:Number(targets.t2||0)},
    {name:"å·…å³°è‡ªç”±", target:Number(targets.t3||0)}
  ];

  const wrap = $("fireBars");
  wrap.innerHTML = "";

  const etaOn = !!db.prefs.etaEnabled;
  $("etaState").textContent = etaOn ? "å¼€å¯" : "å…³é—­";
  $("etaNote").style.display = etaOn ? "block" : "none";

  const S = Number(db.settings.monthlySaving||0);
  const yearly = isFinite(r) ? r : 0;

  rows.forEach(row=>{
    const t = row.target;
    const p = t>0 ? Math.min(1, monthlyPassive/t) : 0;
    const gap = Math.max(0, t - monthlyPassive);

    let etaText = "";
    if(etaOn && t>0){
      // estimate years to reach target passive income: need asset = t*12/r
      // if r==0, cannot compute
      if(yearly > 0){
        const needAsset = (t*12)/yearly;
        const years = estimateYears(investableBase, S, yearly, needAsset);
        etaText = years == null ? " Â· å¹´é™ï¼šâ€”" : ` Â· çº¦ ${years.toFixed(1)} å¹´`;
      }else{
        etaText = " Â· å¹´é™ï¼šâ€”";
      }
    }

    const item = document.createElement("div");
    item.className = "barItem";
    item.innerHTML = `
      <div class="barTop">
        <div><b>${row.name}</b> <span class="muted2">Â· ç›®æ ‡ ${masked(fmtMoney(t, base))}/æœˆ</span></div>
        <div class="muted">${masked(fmtMoney(monthlyPassive, base))}/æœˆ</div>
      </div>
      <div class="barTrack"><div class="barFill" style="width:${Math.max(2, p*100)}%"></div></div>
      <div class="small muted2">å·®é¢ï¼š${masked(fmtMoney(gap, base))}/æœˆ${etaText}</div>
    `;
    wrap.appendChild(item);
  });
}

function estimateYears(A, S, r, targetA){
  // monthly compounding approximation
  // If already reached
  if(A >= targetA) return 0;
  if(S <= 0 && r <= 0) return null;

  const m = r/12;
  let a = A;
  let months = 0;
  const maxMonths = 12*100; // cap 100y
  while(a < targetA && months < maxMonths){
    a = a*(1+m) + S;
    months++;
  }
  if(months >= maxMonths) return null;
  return months/12;
}

function renderSnapshots(sum){
  const snaps = db.snapshots || [];
  const card = $("snapshotCard");
  const wrap = $("snapBars");
  const cnt = $("snapCount");

  if(snaps.length < 2){
    card.style.display = "none";
    return;
  }
  card.style.display = "block";
  cnt.textContent = snaps.length + " æ¬¡";

  const recent = snaps.slice(0,6).reverse(); // oldest->newest for display
  const maxV = Math.max(...recent.map(s=>s.totalBase||0), 1);

  wrap.innerHTML = "";
  recent.forEach(s=>{
    const p = (s.totalBase||0)/maxV;
    const date = new Date(s.ts).toLocaleDateString();
    const item = document.createElement("div");
    item.className = "barItem";
    item.innerHTML = `
      <div class="barTop">
        <div><b>${date}</b></div>
        <div class="muted">${masked(fmtMoney(s.totalBase||0, s.baseCcy||db.settings.baseCcy))}</div>
      </div>
      <div class="barTrack"><div class="barFill" style="width:${Math.max(2,p*100)}%"></div></div>
    `;
    wrap.appendChild(item);
  });
}

/** ===========================
 *  Records list rendering
 * =========================== */
function renderRecentRecords(){
  const wrap = $("recentRecords");
  const list = db.records.slice(0,10);
  $("recCount").textContent = list.length;

  if(!list.length){
    wrap.innerHTML = `<div class="small muted">æš‚æ— è®°å½•ã€‚ç‚¹å³ä¸‹è§’â€œè®°ä¸€ç¬”â€å¼€å§‹ï½</div>`;
    return;
  }

  const accMap = Object.fromEntries(db.accounts.map(a=>[a.id,a.name]));
  const catMap = Object.fromEntries(db.categories.map(c=>[c.id,c.name]));

  wrap.innerHTML = "";
  list.forEach(r=>{
    const item = document.createElement("div");
    item.className = "item";
    item.innerHTML = `
      <div class="itemTitle">${catMap[r.categoryId]||"æœªåˆ†ç±»"} Â· ${masked(fmtMoney(r.amount, r.ccy))}</div>
      <div class="itemMeta">
        <span class="tag">${accMap[r.accountId]||"æœªçŸ¥è´¦æˆ·"}</span>
        <span class="tag">${r.ccy}</span>
        <span class="tag">${new Date(r.ts).toLocaleString()}</span>
        ${r.note ? `<span class="tag">${escapeHtml(r.note)}</span>` : ``}
      </div>
    `;
    wrap.appendChild(item);
  });
}

function renderAllRecentSheet(){
  const wrap = $("allRecentList");
  const list = db.records.slice(0,50);
  const accMap = Object.fromEntries(db.accounts.map(a=>[a.id,a.name]));
  const catMap = Object.fromEntries(db.categories.map(c=>[c.id,c.name]));

  if(!list.length){
    wrap.innerHTML = `<div class="small muted">æš‚æ— è®°å½•ã€‚</div>`;
    return;
  }

  wrap.innerHTML = "";
  list.forEach(r=>{
    const item = document.createElement("div");
    item.className = "item";
    item.innerHTML = `
      <div class="itemTitle">${catMap[r.categoryId]||"æœªåˆ†ç±»"} Â· ${masked(fmtMoney(r.amount, r.ccy))}</div>
      <div class="itemMeta">
        <span class="tag">${accMap[r.accountId]||"æœªçŸ¥è´¦æˆ·"}</span>
        <span class="tag">${r.ccy}</span>
        <span class="tag">${new Date(r.ts).toLocaleString()}</span>
        <button class="btn" style="padding:6px 10px;border-radius:12px" data-del="${r.id}">åˆ é™¤</button>
      </div>
      ${r.note ? `<div class="small muted2" style="margin-top:8px">${escapeHtml(r.note)}</div>` : ``}
    `;
    wrap.appendChild(item);
  });

  wrap.querySelectorAll("[data-del]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const id = btn.dataset.del;
      if(!confirm("ç¡®å®šåˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ")) return;
      db.records = db.records.filter(x=>x.id!==id);
      saveDB();
      renderAll();
      renderAllRecentSheet();
    });
  });
}

function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, m => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
  }[m]));
}

/** ===========================
 *  Accounts & Categories ê´€ë¦¬
 * =========================== */
function renderAccountsManager(){
  const wrap = $("accountList");
  wrap.innerHTML = "";
  db.accounts.forEach(a=>{
    const item = document.createElement("div");
    item.className = "item";
    item.innerHTML = `
      <div class="itemTitle">${escapeHtml(a.name)}</div>
      <div class="itemMeta">
        <span class="tag">${a.id}</span>
        <button class="btn" style="padding:6px 10px;border-radius:12px" data-delacc="${a.id}">åˆ é™¤</button>
      </div>
    `;
    wrap.appendChild(item);
  });

  wrap.querySelectorAll("[data-delacc]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const id = btn.dataset.delacc;
      if(db.accounts.length<=1) return alert("è‡³å°‘ä¿ç•™ä¸€ä¸ªè´¦æˆ·");
      if(!confirm("åˆ é™¤è´¦æˆ·ä¼šåŒæ—¶åˆ é™¤ç›¸å…³è®°å½•çš„â€œè´¦æˆ·å¼•ç”¨â€ï¼ˆè®°å½•ä»ä¿ç•™ä½†æ˜¾ç¤ºä¸ºæœªçŸ¥è´¦æˆ·ï¼‰ã€‚ç»§ç»­ï¼Ÿ")) return;
      db.accounts = db.accounts.filter(a=>a.id!==id);
      saveDB();
      populateAccountSelect();
      renderAccountsManager();
      renderAll();
    });
  });
}

function renderCategoriesManager(){
  const wrap = $("catList");
  wrap.innerHTML = "";
  const cats = [...db.categories].sort((a,b)=>a.order-b.order);
  cats.forEach(c=>{
    const item = document.createElement("div");
    item.className = "item";
    item.innerHTML = `
      <div class="itemTitle">${escapeHtml(c.name)}</div>
      <div class="itemMeta">
        <span class="tag">order=${c.order}</span>
        <button class="btn" style="padding:6px 10px;border-radius:12px" data-up="${c.id}">ä¸Šç§»</button>
        <button class="btn" style="padding:6px 10px;border-radius:12px" data-down="${c.id}">ä¸‹ç§»</button>
        <button class="btn" style="padding:6px 10px;border-radius:12px" data-delcat="${c.id}">åˆ é™¤</button>
      </div>
    `;
    wrap.appendChild(item);
  });

  wrap.querySelectorAll("[data-up]").forEach(btn=>{
    btn.addEventListener("click", ()=>moveCat(btn.dataset.up, -1));
  });
  wrap.querySelectorAll("[data-down]").forEach(btn=>{
    btn.addEventListener("click", ()=>moveCat(btn.dataset.down, +1));
  });
  wrap.querySelectorAll("[data-delcat]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const id = btn.dataset.delcat;
      if(db.categories.length<=2) return alert("è‡³å°‘ä¿ç•™ä¸¤ä¸ªç±»åˆ«");
      if(!confirm("åˆ é™¤ç±»åˆ«ä¸ä¼šåˆ é™¤è®°å½•ï¼Œä½†è¯¥ç±»åˆ«è®°å½•ä¼šæ˜¾ç¤ºä¸ºæœªåˆ†ç±»ã€‚ç»§ç»­ï¼Ÿ")) return;
      db.categories = db.categories.filter(c=>c.id!==id);
      if(activeCatId===id) activeCatId = db.categories[0]?.id || null;
      saveDB();
      renderCategoriesManager();
      renderCatChips();
      renderAll();
    });
  });
}

function moveCat(id, delta){
  const cats = [...db.categories].sort((a,b)=>a.order-b.order);
  const idx = cats.findIndex(c=>c.id===id);
  if(idx<0) return;
  const j = idx + delta;
  if(j<0 || j>=cats.length) return;
  // swap orders
  const a = cats[idx], b = cats[j];
  const tmp = a.order; a.order = b.order; b.order = tmp;
  // write back
  const map = Object.fromEntries(cats.map(c=>[c.id,c.order]));
  db.categories = db.categories.map(c=>({ ...c, order: map[c.id] ?? c.order }));
  saveDB();
  renderCategoriesManager();
  renderCatChips();
  renderAll();
}

/** ===========================
 *  Settings
 * =========================== */
function loadSettingsToUI(){
  $("setBaseCcy").value = db.settings.baseCcy || "CNY";
  $("setR").value = (db.settings.annualReturn ?? 0.06);
  $("setS").value = (db.settings.monthlySaving ?? 0);

  $("t1").value = db.settings.targets?.t1 ?? 20000;
  $("t2").value = db.settings.targets?.t2 ?? 50000;
  $("t3").value = db.settings.targets?.t3 ?? 70000;

  $("fxHKD").value = db.settings.fx?.HKD ?? "";
  $("fxUSD").value = db.settings.fx?.USD ?? "";
}

function saveSettingsFromUI(){
  db.settings.baseCcy = $("setBaseCcy").value;

  const r = Number(($("setR").value||"").toString().trim());
  db.settings.annualReturn = Number.isFinite(r) ? r : 0;

  const s = Number(($("setS").value||"").toString().trim());
  db.settings.monthlySaving = Number.isFinite(s) ? s : 0;

  db.settings.targets = {
    t1: Number(($("t1").value||"").toString().trim()) || 20000,
    t2: Number(($("t2").value||"").toString().trim()) || 50000,
    t3: Number(($("t3").value||"").toString().trim()) || 70000,
  };

  const fxHKD = Number(($("fxHKD").value||"").toString().trim());
  const fxUSD = Number(($("fxUSD").value||"").toString().trim());
  db.settings.fx = {
    HKD: Number.isFinite(fxHKD) && fxHKD>0 ? fxHKD : null,
    USD: Number.isFinite(fxUSD) && fxUSD>0 ? fxUSD : null
  };

  saveDB();
  renderAll();
}

/** ===========================
 *  Export / Import
 * =========================== */
function exportJSON(){
  const payload = {
    ...db,
    exportedAt: new Date().toISOString()
  };
  const blob = new Blob([JSON.stringify(payload, null, 2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "portfolio_backup.json";
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

function importJSONFile(file){
  const reader = new FileReader();
  reader.onload = () => {
    try{
      const incoming = JSON.parse(reader.result);
      // merge strategy: replace by default, but keep version and ensure arrays exist
      db = { ...DEFAULT(), ...incoming };
      saveDB();
      // reinit
      initUI();
      renderAll();
      alert("å¯¼å…¥æˆåŠŸ âœ…");
    }catch(e){
      alert("å¯¼å…¥å¤±è´¥ï¼šJSON ä¸åˆæ³•");
    }
  };
  reader.readAsText(file);
}

/** ===========================
 *  Snapshots
 * =========================== */
function saveSnapshot(){
  const sum = summarize();
  const base = db.settings.baseCcy;
  let totalBase = sum.totalBase;
  if(totalBase == null){
    // fallback: base currency only
    totalBase = sum.totalsByCcy[base] || 0;
  }
  db.snapshots.unshift({
    id: uid("snap"),
    ts: new Date().toISOString(),
    baseCcy: base,
    totalBase
  });
  db.snapshots = db.snapshots.slice(0,120); // keep 120
  saveDB();
  renderAll();
  alert("å·²ä¿å­˜å¿«ç…§ âœ…");
}

/** ===========================
 *  Bindings
 * =========================== */
$("btnTheme").addEventListener("click", ()=>{
  const th = currentTheme()==="dark" ? "light" : "dark";
  setTheme(th);
});
$("btnMask").addEventListener("click", ()=>{
  setMask(!db.prefs.mask);
});
$("btnSaveSettings").addEventListener("click", ()=>{
  saveSettingsFromUI();
  alert("å·²ä¿å­˜è®¾ç½® âœ…");
});
$("btnReset").addEventListener("click", ()=>{
  if(!confirm("æ¢å¤é»˜è®¤ä¼šè¦†ç›–ä½ çš„è®¾ç½®ï¼ˆä¸ä¼šåˆ é™¤è®°å½•ï¼‰ã€‚ç»§ç»­ï¼Ÿ")) return;
  const keep = { records: db.records, snapshots: db.snapshots, accounts: db.accounts, categories: db.categories, prefs: db.prefs };
  db = DEFAULT();
  db.records = keep.records;
  db.snapshots = keep.snapshots;
  db.accounts = keep.accounts;
  db.categories = keep.categories;
  db.prefs = keep.prefs;
  saveDB();
  loadSettingsToUI();
  renderAll();
});
$("btnManageAccounts").addEventListener("click", ()=>{
  renderAccountsManager();
  openOverlay("ovAccounts");
});
$("btnManageCategories").addEventListener("click", ()=>{
  renderCategoriesManager();
  openOverlay("ovCategories");
});
$("btnAddAccount").addEventListener("click", ()=>{
  const name = ($("newAccountName").value||"").trim();
  if(!name) return;
  db.accounts.push({ id: uid("acc"), name });
  $("newAccountName").value = "";
  saveDB();
  populateAccountSelect();
  renderAccountsManager();
  renderAll();
});
$("btnAddCat").addEventListener("click", ()=>{
  const name = ($("newCatName").value||"").trim();
  if(!name) return;
  const maxOrder = Math.max(...db.categories.map(c=>c.order), 0);
  db.categories.push({ id: uid("cat"), name, order: maxOrder+1 });
  $("newCatName").value = "";
  saveDB();
  renderCategoriesManager();
  renderCatChips();
  renderAll();
});
$("btnExport").addEventListener("click", exportJSON);
$("btnImport").addEventListener("click", ()=>$("fileImport").click());
$("fileImport").addEventListener("change", (e)=>{
  const f = e.target.files?.[0];
  if(f) importJSONFile(f);
  e.target.value = "";
});
$("btnToggleETA").addEventListener("click", ()=>{
  db.prefs.etaEnabled = !db.prefs.etaEnabled;
  saveDB();
  renderAll();
});
$("btnSaveSnapshot").addEventListener("click", saveSnapshot);

/** ===========================
 *  Init / Render
 * =========================== */
function initUI(){
  // theme
  setTheme(db.prefs.theme || "dark");
  setMask(!!db.prefs.mask);

  // settings
  loadSettingsToUI();

  // selects
  populateAccountSelect();
  renderCatChips();
}

function renderAll(){
  const sum = summarize();
  renderTotals(sum);
  renderCategoryBars(sum);
  renderFIRE(sum);
  renderRecentRecords();
  renderSnapshots(sum);
}

initUI();
renderAll();
switchTab("overview");
</script>
</body>
</html>